import{r as n,j as e,B as j,a1 as K,b as ve,a as Ie,a0 as W,o as we,a2 as z,m as be}from"./index-XzM8Cj3c.js";import{a as Se,u as te,b as oe,c as Ne,d as De,e as se,D as Ce,f as Fe,S as Ge,v as Me,g as Oe,s as _e,K as $e,P as Ee,h as Re,C as Ue,R as ae,V as Le}from"./sortable.esm-DN6roczm.js";import{a as ke}from"./useFetchvendorVenues-D949lnpY.js";import{F as U}from"./index-BLf5ALDk.js";import{M as J}from"./index-BTmfCYkW.js";import{U as ne}from"./index-DpVHb5nB.js";import{R as ie}from"./UploadOutlined-Bi9pOI5I.js";import{s as i}from"./index-Yvuj0Esb.js";import{S as T}from"./index-Ci-vNBFy.js";import{I as Pe}from"./index-CthMyroC.js";import{R as le}from"./EyeOutlined-BVmecd_y.js";import{C as Ae}from"./index-C1XA4k9t.js";import{B as ze}from"./index-D8JKXGq0.js";import{R as Te}from"./DeleteOutlined-Ke0rSpX_.js";import"./useQuery-Beh9q-Hu.js";import"./useMutation-CNNl5TnA.js";import"./useForm-EwlPOCpB.js";import"./row-CTTWbxgc.js";import"./index-BfZvbS5e.js";import"./ExclamationCircleFilled-D7dRXMD9.js";import"./InfoCircleFilled-Ce5_6Fhy.js";import"./ActionButton-DmSr_qh1.js";import"./SearchOutlined-B0571LVy.js";import"./useClosable-B4NhgZhJ.js";import"./extendsObject-78o_rR5W.js";import"./Skeleton-BxJpOdZN.js";import"./fade-_qbex92f.js";import"./DownloadOutlined-D_mskBw8.js";import"./progress-DW_vC4dS.js";import"./addEventListener-kraIZfrw.js";import"./PlusOutlined-Dj0tFLrA.js";const{Option:Ss}=T,Be=({isVisible:r,onClose:a,selectedGymId:o})=>{const[S]=U.useForm(),[v,w]=n.useState(!1),[d,h]=n.useState([]),[f,F]=n.useState(1),G=Se(),{data:p}=te({venueId:o,type:3});n.useEffect(()=>{if(p?.result&&p.result.length>0){const u=p.result.map(g=>g.display_order).filter(g=>g!=null),c=Math.max(...u,0);F(c+1)}else F(1)},[p,o]);const t=async u=>{if(!o){i.error("Please select a gym first");return}if(d.length===0){i.error("Please select an image to upload");return}try{w(!0);const c=new FormData;c.append("venueId",o),c.append("type",3),c.append("displayOrder",f);const g=d[0].originFileObj||d[0];c.append("image",g),console.log("📤 Adding gym image with formData:",c),await G.mutateAsync(c),S.resetFields(),h([]),a()}catch(c){console.error("❌ Add gym images error:",c)}finally{w(!1)}},O=()=>{S.resetFields(),h([]),a()};return e.jsx(J,{title:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsx(K,{style:{color:"#1163C7"}}),"Add Gym Images"]}),open:r,onCancel:O,footer:null,width:600,centered:!0,destroyOnClose:!0,children:e.jsxs(U,{form:S,layout:"vertical",onFinish:t,className:"add-gym-image-form",children:[e.jsxs(U.Item,{label:"Upload Image",required:!0,children:[e.jsx(ne,{accept:"image/*",beforeUpload:u=>u.type.startsWith("image/")?u.size/1024/1024<10?(h([{uid:u.uid||Date.now(),name:u.name,status:"done",originFileObj:u,url:URL.createObjectURL(u)}]),!1):(i.error("Image must be smaller than 10MB!"),!1):(i.error("You can only upload image files!"),!1),multiple:!1,fileList:d,onRemove:()=>h([]),listType:"text",showUploadList:{showPreviewIcon:!1,showRemoveIcon:!0,showDownloadIcon:!1},children:e.jsx(j,{icon:e.jsx(ie,{}),disabled:v,children:"Select Image"})}),e.jsx("div",{style:{marginTop:8,color:"#666",fontSize:"12px"},children:"Supported formats: JPG, PNG, GIF. Max size: 10MB"})]}),e.jsxs("div",{className:"form-actions",children:[e.jsx(j,{onClick:O,disabled:v,children:"Cancel"}),e.jsx(j,{type:"primary",htmlType:"submit",loading:v,style:{marginLeft:"8px"},children:v?"Adding...":"Add Gym Images"})]})]})})},Ve=({isVisible:r,onClose:a,selectedImage:o,selectedGymId:S})=>{const[v]=U.useForm(),[w,d]=n.useState(!1),[h,f]=n.useState([]),F=oe();n.useEffect(()=>{o&&r&&(o.image_url?f([{uid:"existing-image",name:"existing-image.jpg",status:"done",url:o.image_url}]):f([]))},[o,r]);const G=async()=>{if(!o||!S){i.error("Missing image or gym information");return}try{d(!0);const t=new FormData;t.append("imageGalleryId",o.id),t.append("venueId",S),t.append("type",3),t.append("displayOrder",o.display_order||1),h.length>0&&h[0].originFileObj&&t.append("image",h[0].originFileObj),console.log("📤 Updating gym image with formData:",t),await F.mutateAsync(t),v.resetFields(),f([]),a()}catch(t){console.error("❌ Update gym image error:",t)}finally{d(!1)}},p=()=>{v.resetFields(),f([]),a()};return o?e.jsx(J,{title:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsx(K,{style:{color:"#1163C7"}}),"Edit Gym Image - #",o.display_order||"N/A"]}),open:r,onCancel:p,footer:null,width:600,centered:!0,destroyOnClose:!0,children:e.jsxs(U,{layout:"vertical",className:"edit-gym-image-form",onFinish:G,children:[e.jsx(U.Item,{label:"Upload New Image (Optional)",children:e.jsx(ne,{accept:"image/*",beforeUpload:t=>t.type.startsWith("image/")?t.size/1024/1024<10?(f([{uid:t.uid||Date.now(),name:t.name,status:"done",originFileObj:t,url:URL.createObjectURL(t)}]),!1):(i.error("Image must be smaller than 10MB!"),!1):(i.error("You can only upload image files!"),!1),maxCount:1,fileList:h,onRemove:()=>f([]),listType:"text",showUploadList:{showPreviewIcon:!1,showRemoveIcon:!0,showDownloadIcon:!1},children:h.length>=1?null:e.jsx(j,{icon:e.jsx(ie,{}),children:"Select New Image"})})}),e.jsxs("div",{className:"form-actions",children:[e.jsx(j,{onClick:p,disabled:w,children:"Cancel"}),e.jsx(j,{type:"primary",htmlType:"submit",loading:w,style:{marginLeft:"8px"},children:w?"Updating...":"Update Gym Image"})]})]})}):null};class We extends we.Component{constructor(a){super(a),this.state={hasError:!1,error:null,errorInfo:null}}static getDerivedStateFromError(a){return{hasError:!0}}componentDidCatch(a,o){this.setState({error:a,errorInfo:o}),console.error("Drag and Drop Error Boundary caught an error:",a,o)}render(){return this.state.hasError?e.jsx("div",{className:"drag-drop-error-fallback",children:e.jsxs("div",{className:"error-content",children:[e.jsx("h3",{children:"Image Reordering Temporarily Unavailable"}),e.jsx("p",{children:"We're experiencing a technical issue with image reordering. Please try refreshing the page or contact support if the problem persists."}),e.jsx(j,{type:"primary",onClick:()=>window.location.reload(),style:{marginTop:"16px"},children:"Refresh Page"})]})}):this.props.children}}const{Option:re}=T;Array(6).fill(Le);const Ke=({image:r,index:a,deletingImageId:o,onDelete:S,onEdit:v,onView:w,isReordering:d=!1})=>{const{attributes:h,listeners:f,setNodeRef:F,transform:G,transition:p,isDragging:t,isOver:O}=Re({id:r.id,disabled:o===r.id||d}),u={transform:Ue.Transform.toString(G),transition:t?"none":p,opacity:t?.3:1,zIndex:t?1e3:"auto"},c={role:"button",tabIndex:0,"aria-label":`Gym Image ${r.display_order||a+1}, drag to reorder`,"aria-describedby":`image-${r.id}-description`,"data-testid":`sortable-gym-image-${r.id}`};return e.jsx("div",{ref:F,style:u,...h,...c,className:`sortable-image-wrapper ${t?"dragging":""} ${O?"drag-over":""}`,children:e.jsxs(Ae,{className:`compact-image-card enterprise-card ${o===r.id?"deleting":""} ${t?"dragging":""} ${d?"reordering":""}`,hoverable:o!==r.id&&!t&&!d,cover:e.jsxs("div",{className:"compact-image-container",onClick:()=>o!==r.id&&!t&&w(r),onKeyDown:g=>{(g.key==="Enter"||g.key===" ")&&(g.preventDefault(),o!==r.id&&!t&&w(r))},children:[e.jsx("img",{src:r.image_url,alt:`Gym Image ${r.display_order||a+1}`,className:"compact-image",loading:"lazy",onError:g=>{console.warn(`Failed to load gym image ${r.id}:`,g),g.target.style.display="none"}}),e.jsx("div",{className:"compact-overlay",children:e.jsx(z,{title:"Click to view full size",children:e.jsx(j,{type:"primary",shape:"circle",icon:e.jsx(le,{}),size:"small",className:"compact-overlay-btn",disabled:o===r.id||t,"aria-label":"View full size gym image"})})}),o===r.id&&e.jsxs("div",{className:"delete-loading-overlay",children:[e.jsx(W,{size:"large"}),e.jsx("span",{className:"delete-loading-text",children:"Deleting..."})]}),t&&e.jsx("div",{className:"drag-indicator",children:e.jsxs("div",{className:"drag-indicator-content",children:[e.jsx(ae,{}),e.jsx("span",{children:"Moving..."})]})})]}),size:"small",actions:[e.jsx(z,{title:"Drag to reorder",children:e.jsx(j,{type:"text",icon:e.jsx(ae,{}),className:"compact-action-btn drag-btn",size:"small",disabled:o===r.id||d,...f,"aria-label":"Drag to reorder gym image"})},"drag"),e.jsx(z,{title:"Edit Image",children:e.jsx(j,{type:"text",icon:e.jsx(be,{}),onClick:()=>v(r),className:"compact-action-btn edit-btn",size:"small",disabled:t||d,"aria-label":"Edit gym image"})},"edit"),e.jsx(z,{title:o===r.id?"Deleting...":"Delete Image",children:e.jsx(j,{type:"text",danger:!0,icon:e.jsx(Te,{}),onClick:()=>S(r),className:"compact-action-btn delete-btn",size:"small",loading:o===r.id,disabled:o===r.id||t||d,"aria-label":"Delete gym image"})},"delete")],children:[e.jsxs("div",{className:"compact-meta",children:[e.jsx(ze,{count:r.display_order||a+1,style:{backgroundColor:"#1163C7",fontSize:"10px"},size:"small"}),e.jsxs("span",{className:"compact-position",children:["#",r.display_order||a+1]}),t&&e.jsx("span",{className:"drag-status",children:"Moving..."})]}),e.jsxs("div",{id:`image-${r.id}-description`,className:"sr-only",children:["Gym Image ",r.display_order||a+1," of gym gallery. Use drag handle to reorder."]})]})})},Ns=()=>{const r=ve(s=>s.auth.user.id),[a,o]=n.useState(null),[S,v]=n.useState(!1),[w,d]=n.useState(!1),[h,f]=n.useState(!1),[F,G]=n.useState(null),[p,t]=n.useState(null),[O,u]=n.useState(null),[c,g]=n.useState(!1),[Y,q]=n.useState(!1);Ie();const{data:N,loading:L,error:H}=ke(r),{data:k,loading:Q,error:X}=te({venueId:a||1,type:3}),de=Ne(),Z=oe(),ce=De(se(Ee,{activationConstraint:{distance:8,delay:100,tolerance:5}}),se($e,{coordinateGetter:_e}));n.useEffect(()=>{N?.result?.length&&!a&&o(N.result[0].Id)},[N,a]);const ee=s=>{q(!0),o(s),setTimeout(()=>{q(!1)},500)};n.useEffect(()=>{H&&i.error("Failed to load gym list"),X&&i.error("Failed to load gym images")},[H,X]);const B=n.useMemo(()=>N?.result?.find(s=>s.Id===a),[N?.result,a]),x=n.useMemo(()=>k?.result?[...k.result].sort((s,m)=>s.display_order-m.display_order):[],[k?.result]),me=n.useMemo(()=>x.map(s=>s.id),[x]),ge=s=>{const{active:m}=s;console.log("🎯 Drag started:",{imageId:m.id,timestamp:new Date().toISOString(),operation:"drag_start"})},pe=s=>{const{active:m,over:b}=s;b&&m.id!==b.id&&console.log("🎯 Drag over valid drop zone:",{from:m.id,to:b.id,timestamp:new Date().toISOString()})},ue=s=>{console.log("🚫 Drag cancelled:",{reason:s.active?"user_cancelled":"system_cancelled",timestamp:new Date().toISOString()})},ye=async s=>{const{active:m,over:b}=s;if(!m.id||!b?.id||m.id===b.id)return;const A=x.findIndex(y=>y.id===m.id),P=x.findIndex(y=>y.id===b.id);if(A===-1||P===-1){console.warn("Invalid drag operation: image not found in list"),i.warning("Unable to reorder: image not found");return}const I=Oe(x,A,P).map((y,D)=>{const C=D+1;return y.display_order!==C?{...y,newDisplayOrder:C,oldDisplayOrder:y.display_order}:null}).filter(Boolean);if(I.length===0){console.log("No position changes detected, skipping update");return}g(!0);const $=i.loading({content:`Reordering ${I.length} image${I.length>1?"s":""}...`,duration:0,key:"reorder-loading"});try{console.log("🔄 Starting enterprise reorder operation:",{totalImages:x.length,imagesToUpdate:I.length,gymId:a,operation:"drag_drop_reorder"});const y=I.map(async(l,E=0)=>{try{const M=new FormData;M.append("venueId",String(a)),M.append("type","3"),M.append("displayOrder",String(l.newDisplayOrder)),M.append("imageGalleryId",String(l.id)),console.log(`📤 Updating image ${l.id}: ${l.oldDisplayOrder} → ${l.newDisplayOrder}`);const R=await Z.mutateAsync(M);if(R?.status!==200)throw new Error(`Unexpected response status: ${R?.status}`);return{success:!0,imageId:l.id,newOrder:l.newDisplayOrder}}catch(M){if(console.error(`❌ Failed to update image ${l.id} (attempt ${E+1}):`,M),E<2)return console.log(`🔄 Retrying update for image ${l.id}...`),await new Promise(R=>setTimeout(R,1e3*(E+1))),y[y.indexOf(y.find(R=>R.imageId===l.id))](l,E+1);throw{imageId:l.id,error:M.message||"Unknown error",retryCount:E+1}}}),D=await Promise.allSettled(y),C=D.filter(l=>l.status==="fulfilled").length,V=D.filter(l=>l.status==="rejected").length;if(console.log("📊 Reorder operation results:",{total:D.length,successful:C,failed:V,successRate:`${Math.round(C/D.length*100)}%`}),V===0)i.success({content:`Successfully reordered ${C} image${C>1?"s":""}`,duration:3,key:"reorder-success"});else if(C>0)i.warning({content:`Partially completed: ${C} successful, ${V} failed. Some images may not be in the correct order.`,duration:5,key:"reorder-partial"}),D.forEach((l,E)=>{l.status==="rejected"&&console.error("Failed image update:",l.reason)});else throw new Error("All reorder operations failed")}catch(y){console.error("❌ Enterprise reorder operation failed:",y);const D=y.message||"Unknown error occurred";i.error({content:`Reorder failed: ${D}. Please try again or contact support if the issue persists.`,duration:8,key:"reorder-error"})}finally{$(),g(!1)}},he=n.useCallback(()=>{if(x?.length>=6){i.warning("Maximum of 6 images allowed per gym. Please delete an existing image to add a new one.");return}v(!0)},[x?.length]),fe=n.useCallback(s=>{console.log("✏️ Editing gym image:",s),G(s),d(!0)},[]),xe=n.useCallback(s=>{console.log("👁️ Viewing gym image:",s),t(s),f(!0)},[]),je=async s=>{try{u(s.id),console.log("🗑️ Deleting image:",s);const m={imageId:s.id,venueId:a};console.log("📋 Delete payload:",m);const b=await de.mutateAsync(m);if(console.log("✅ Delete result:",b),b?.status===200){i.success("Image deleted successfully!"),console.log("✅ Delete successful - Status 200 confirmed");const A=s.display_order,P=x.filter(_=>_.id!==s.id&&_.display_order>A).sort((_,I)=>_.display_order-I.display_order);if(P.length>0){const _=i.loading("Reordering images...",0);try{await Promise.all(P.map(async I=>{const $=new FormData;return $.append("venueId",String(a)),$.append("type","3"),$.append("displayOrder",String(I.display_order-1)),$.append("imageGalleryId",String(I.id)),Z.mutateAsync($)})),i.success("Images reordered")}catch(I){console.error("❌ Reorder error:",I),i.error("Failed to reorder images")}finally{_()}}}else i.warning("Image deleted but unexpected response status"),console.log("⚠️ Unexpected status:",b?.status)}catch(m){console.error("❌ Delete error:",m),i.error("Failed to delete image")}finally{u(null)}};return L?e.jsx("div",{className:"venue-card",children:e.jsxs("div",{className:"page-loading-container",children:[e.jsx(W,{size:"large"}),e.jsx("div",{className:"page-loading-text",children:"Loading gyms..."})]})}):!a||Y||a&&Q||a&&!k?e.jsxs("div",{className:"venue-card",children:[e.jsxs("div",{className:"venue-toolbar",children:[e.jsx(T,{placeholder:"Select Gym",className:"venue-select",loading:L,onChange:ee,value:a||void 0,disabled:L||!N?.result?.length,children:N?.result?.map(s=>e.jsx(re,{value:s.Id,children:s.gym_name},s.Id))}),e.jsx(j,{type:"primary",className:"add-btn",disabled:!0,children:"+ Add Gym Image"})]}),e.jsx("h3",{className:"venue-title",children:B?.gym_name||"Select a gym to view images"}),e.jsxs("div",{className:"page-loading-container",children:[e.jsx(W,{size:"large"}),e.jsx("div",{className:"page-loading-text",children:a?Y?"Switching gym...":a&&!k?"Fetching gym images...":"Loading images...":"Please select a gym to view images"})]})]}):e.jsxs("div",{className:"venue-card",children:[e.jsxs("div",{className:"venue-toolbar",children:[e.jsx(T,{placeholder:"Select Gym",className:"venue-select",loading:L,onChange:ee,value:a||void 0,disabled:L||!N?.result?.length,children:N?.result?.map(s=>e.jsx(re,{value:s.Id,children:s.gym_name},s.Id))}),e.jsxs(j,{type:"primary",className:"add-btn",disabled:!a||x?.length>=6||Q||c,onClick:he,children:["+ Add Gym Image",x?.length>=6&&e.jsx("span",{className:"max-limit-indicator",children:" (Max 6)"}),c&&e.jsx("span",{className:"reordering-indicator",children:" (Reordering...)"})]})]}),e.jsx("h3",{className:"venue-title",children:B?.gym_name||"Select a gym to view images"}),e.jsx(We,{children:e.jsx(Ce,{sensors:ce,collisionDetection:Fe,onDragStart:ge,onDragOver:pe,onDragEnd:ye,onDragCancel:ue,children:e.jsx("div",{className:"image-grid",children:x?.length>0?e.jsx(Ge,{items:me,strategy:Me,children:x.map((s,m)=>e.jsx(Ke,{image:s,index:m,deletingImageId:O,onDelete:je,onEdit:fe,onView:xe,isReordering:c},s.id))}):e.jsx("div",{className:"empty-state-container",children:e.jsxs("div",{className:"empty-state-content",children:[e.jsx("div",{className:"empty-state-icon",children:e.jsx(K,{})}),e.jsx("h3",{className:"empty-state-title",children:"No Images Found"}),e.jsx("p",{className:"empty-state-description",children:`This gym doesn't have any images yet. Click the "Add Gym Image" button to upload your first image.`}),e.jsxs("div",{className:"empty-state-info",children:[e.jsxs("div",{className:"info-item",children:[e.jsx("span",{className:"info-label",children:"Maximum Images:"}),e.jsx("span",{className:"info-value",children:"6 images per gym"})]}),e.jsxs("div",{className:"info-item",children:[e.jsx("span",{className:"info-label",children:"Supported Formats:"}),e.jsx("span",{className:"info-value",children:"JPG, PNG, GIF"})]}),e.jsxs("div",{className:"info-item",children:[e.jsx("span",{className:"info-label",children:"Max File Size:"}),e.jsx("span",{className:"info-value",children:"10MB per image"})]})]})]})})})})}),e.jsx(J,{title:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsx(le,{style:{color:"#1163C7"}}),"View Image - Position ",p?.display_order]}),open:h,onCancel:()=>{f(!1),t(null)},footer:null,width:"auto",centered:!0,style:{maxWidth:"90vw"},children:p&&e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx(Pe,{src:p.image_url,alt:`Gym Image ${p.display_order}`,style:{maxWidth:"100%",maxHeight:"70vh",objectFit:"contain"},preview:!1}),e.jsxs("div",{style:{marginTop:"16px",padding:"12px",backgroundColor:"#f5f5f5",borderRadius:"8px",textAlign:"left"},children:[e.jsxs("div",{style:{marginBottom:"8px"},children:[e.jsx("strong",{children:"Position:"})," #",p.display_order]}),e.jsxs("div",{style:{marginBottom:"8px"},children:[e.jsx("strong",{children:"Gym:"})," ",B?.gym_name]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Type:"})," Gallery Image"]})]})]})}),e.jsx(Be,{isVisible:S,onClose:()=>v(!1),selectedGymId:a}),e.jsx(Ve,{isVisible:w,onClose:()=>{d(!1),G(null)},selectedImage:F,selectedGymId:a})]})};export{Ns as default};
